# 什麼是微服務

* 微服務架構，即是把一個單獨的應用程序開發為`一些小服務`，每個小服務運行在自己的進程中，並使用`輕量級機制通訊`，通常是 HTTP，這些服務圍繞業務來構建，並通過`完全自動化部署機制`來獨立部屬。

* 這些小服務可以使用不同的程式語言編寫，以及不同的儲存技術，並保持最低限度的集中式管理 (鬆散耦合)。


* 簡單來說 : 拒絕大型的單體應用，基於業務邊界進行服務拆分，各個服務獨立部署運行。

<br/>

<br/>

# 為何要使用微服務

傳統的`單體應用架構`，有以下特點:

* 學習成本低、開發上手快

* 小規模團隊開發，開發和維運成本可控。


隨著`業務規模不斷擴大`，開發團隊人員的不斷擴張，單體應用會有以下問題 : 

* 低下的部署效率 : 程式量太大，打包一次可能需要很長的時間。

* 團隊協作開發成本高 : 超過5人的 git flow 可能會出現複雜、不好管控的情況。

* 系統高可用性差 : 例如，當只有某一段程式出問題，導致 OOM 時，整個應用程序都會一併掛掉。

* 線上發布變慢。

<br/>

<br/>

# 什麼是 分布式 / 集群 / 節點

* 集群 : 是物理狀態，只要是一堆機器，就可以叫集群。

* 節點 : 集群中的一個服務器。

* 分布式 : 是個工作方式，不同的業務分布在不同的服務上，這些服務器對用戶來說就像單一個系統。


比較 : 

`分布式是指將不同的業務分布在不同的服務上。`

`集群指的是將幾台服務器集中在一起，實現同一個任務`。

例如，京東電商有眾多業務，每個業務背後都有至少10台服務器執行相同業務；所以可以說，`京東是一個分布式系統`，`每個業務可以稱為是一個集群`。

<br/>

<br/>

# 遠程調用

* 分布式系統中，每個服務可能在不同主機，若要互相調用則稱為遠程調用。

* Spring Cloud 中使用 HTTP + JSON 的方式完成遠程調用。

<br/>

<br/>

# 負載均衡

* 分布式系統中，只要是遠程調用，就會牽涉到`負載均衡`。

* A服務需要調用B服務，B服務存在多台機器，A調用任意一個B的服務器都可以完成功能，但為了使每一個服務器不要太忙或太閒，可以使用負載均衡，提升網站健壯性。

* 常見的負載均衡算法 : 

    1. 輪詢 : 第一個請求選擇健康池中的第一個服務器，然後下一個請求選擇第二個服務器，直到最後一個服務器。

    2. 最小連接 : 優先選擇連接數最少，也就是壓力最小的服務器，在 Session 較長的情況下，可以考慮這種方式。

    3. 散列 : 根據請求來源的 IP 去做 Hash 運算，來選擇要轉發的服務器。 這種方式可以一定程度上保證同一個用戶會被轉發到同一台服務器；如果業務上需要保證連接到之前連接的服務器，可以使用這種方式。

<br/>

<br/>

# 服務註冊 / 發現 中心

A服務調用B服務，A服務並不知道B服務當前有哪幾台是正常，那些下，解決這個問題可以引入註冊中心。

當B服務上線時，就會告知註冊中心，此B服務節點為可用狀態，並且註冊中心和B服務之間會建立心跳機制。

當A服務要調用B服務時，會先去註冊中心問哪一台B服務節點可用。

<br/>

<br/>

# 配置中心

微服務每個機器都是一個服務，因此可能有大量配置的問題，當經常需要變更配置時，就會出現問題，因此可另外建一個配置中心的服務。

當A服務的10個節點需要修改配置時，就不必逐個修改，直接在配置中心修改，`動態的`更新A服務的10個配置。

配置中心用來`集中管理`微服務的配置資訊。

<br/>

<br/>

# 服務熔斷 / 服務降級

在微服務架構中，微服務之間通過網路進行通信，存在`相互依賴問題`，當其中一個服務不可用時，有可能會造成雪崩效應，要防止這樣的狀況，必須要有容錯機制來保護服務。

`服務熔斷` : 設置服務的超時時間，當被調用的服務經常失敗達到某個閾值時，可以開啟斷路保護機制，後來的請求就不再去調用這個服務，調用方直接可以返回默認的數據。

`服務降級` : 在維運期間，當系統處於高峰期，系統資源緊張，可以讓非核心業務降級運行。

* 降級 : 某些服務不處理，或簡單處理(拋異常、返回NULL、調用Mock數據、調用Fallback處理邏輯)。

<br/>

<br/>

# API Gateway

微服務中的重要組件，抽象了微服務中的公共功能，同時提供了客戶端`負載均衡`、`服務自動熔斷`、`灰度發布`、`統一認證`、`限流流控`、`日誌統計`等豐富功能，解決了很多API管理難題。