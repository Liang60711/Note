# 慢查詢分析

### 概述
* MySQL 在定義慢查詢有一個變數 `long_query_time`，用來記錄`執行時間超過閾值`的SQL語句，`long_query_time`的預設時間是10秒。

* 預設情況下是關閉的，如果不是需要性能調校，不建議開啟`慢查詢`，因為會對性能造成一定影響，沒有要調校時，記得關閉。

* 通常會搭配 EXPLAIN 來分析慢查詢的執行計畫。

<br/>

<br/>

### 常用指令(整理)

慢查詢相關
```sql
-- 查詢慢查詢次數
show status like 'Slow_queries';
```

系統變數相關
```sql
-- 慢查詢相關變數
show variables like '%slow%';

-- 慢查詢開關
show variables like 'slow_query_log';

-- 慢查詢閾值
show variables like 'long_query_time';

-- 慢查詢日誌路徑
show variables like 'slow_query_log_file';
```


查詢成本相關
```sql
-- 查看上一筆SQL執行計畫的成本
show status like 'last_query_cost';

-- 查看所有的分析報告
show profiles;

-- 查看最新一筆的分析報告
show profile;

-- 指定查看某一筆分析報告
show profile for query 2;
```

<br/>

<br/>

### 開啟慢查詢
開啟慢查詢開關，需要用 global 開啟
```sql
set global slow_query_log = on;
```

設定閾值，可以使用 session 級別的開啟(不指定級別預設就是session)
```sql
set long_query_time = 3;
```

<br/>

<br/>

### 查詢慢查詢


查詢系統變數
```sql
-- 查看是否開啟慢查詢
-- ON / OFF
show variables like '%slow_query_log%';

-- 查看慢查詢的閾值
-- 10 (sec)
show variables like '%long_query_time%';

```

<br/>

<br/>

### Windows 下慢查詢日誌分析工具 mysqldumpslow

此工具在 windows 的路徑在: `C:\Program Files\MySQL\MySQL Server 8.0\bin\mysqldumpslow.pl`，是一個 perl腳本，所以需要先安裝perl。

```shell
# 移動至路徑
cd C:\Program Files\MySQL\MySQL Server 8.0\bin

# 運行，指定提供慢查詢日誌檔的路徑
# 可以在 mysql 中使用 slow_query_log 變數查詢
mysqldumpslow -s t C:\ProgramData\MySQL\MySQL Server 8.0\Data\xxx-slow.log
```

<br/>

<br/>

### Linux 下慢查詢日誌分析工具 mysqldumpslow

```shell
# 移動至路徑
cd /var/lib/mysql

# 運行，查前5筆
mysqldumpslow -s t -t 5 /var/lib/mysql/xxx-slow.log
```