# 事務

## 概述

* 為一個單獨的工作單元，使數據從一種狀態轉變到另一種狀態。

* 保證事務內的所有內容都必須視為`一個工作單元來執行`，當在一個事務中，成功時所有事物被提交(commit)，失敗時將會放棄所有修改，讓整個事務回滾(rollback)到執行前的狀態。 

<br/>

<br/>

## 事務四大原則

`原子性 Atomicity` 

* 指事務是一個不可分割的工作單位，成功全部提交，失敗全部回滾，不會結束在事務中的某個環節。


`一致性 Consistency`

* Wiki定義 : 在事務開始之前和事務結束以後，資料庫的完整性沒有被破壞。這表示`寫入的資料必須完全符合所有的預設規則`。

* 白話解釋 : 不同的數據都會有一些基本的約束，而這些約束在事務前跟事務後都必須要遵守，如果沒辦法遵守事務就必須失敗。

    * 舉例1，當一個帳戶定義了餘額必須 >= 0，帳戶內有200元，轉帳300元出去，餘額為 -100 元，這時與一開始定義的帳戶狀態不同，因此轉帳失敗。

    * 舉例2，資料表中的`身分證字號`欄位設置為`唯一性約束`，在事物提交或回滾時，都需要遵守此約束，否則就破壞了一致性。

`隔離性 Isolation`

* 指一個事務的執行，`不能被其他事務干擾`，隔離性可以防止多個事務並發執行時因交叉執行而導致資料的不一致。

* 交易隔離分為不同級別，包括

    * 讀取未提交 (Read uncommitted)
    
    * 讀取提交 (read committed)

    * 可重複讀取 (repeatable read)
    
    * 串行化 (Serializable)


`持久性 Durability`

* 事務處理結束後，資料的修改就是永久的，即便系統故障也不會遺失；同理也無法再回滾成提交前的狀態。

* 持久性是通過`事務日誌`來保證的。


<br/>

<br/>

## 事務的狀態

MySQL 將事物的狀態分為以下

`活動狀態 Active`

* 事務正在執行過程中，即是活動狀態。

`部分提交狀態 Partially committed`

* 事務中的`最後一筆操作執行完成時`的狀態；由於事務操作都是在記憶體中執行，尚未回寫到硬碟，故為部分提交狀態。

`提交狀態 Committed`

* 當狀態為`部分提交狀態`，將修改後的數據`同步到硬碟`後，即為提交狀態。

`失敗狀態 Failed`

* 當事務在`活動狀態`、`部分提交狀態`時，可能遇到了某些錯誤而無法繼續執行，或人為的停止當前事務的執行，即為失敗狀態。

`中止狀態 Aborted`

* 若事務執行了一部分而變成`失敗狀態`，那就必須把已經修改的操作還原到事務執行前的狀態(回滾)，當回滾執行完畢時的狀態，即是中止狀態。